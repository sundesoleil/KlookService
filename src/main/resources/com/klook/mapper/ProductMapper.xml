<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.klook.mapper.ProductMapper">
	<select id="selectProductSeqList" resultType="java.lang.Integer">
		SELECT kp_seq FROM kl_product
		ORDER BY kp_reg_date 
		DESC LIMIT #{LIMIT}
	</select>
	<select id="selectProduct" resultType="com.klook.vo.ProductVO">

<!-- 		SELECT i.*, j.rate AS rate FROM
		( -->
		SELECT g.*, h.ksc_name AS sub_cate_name FROM
		(
		SELECT e.*, f.kmc_name AS main_cate_name FROM
		(
		SELECT c.*, d.kc_name AS city_name FROM
		(
		SELECT * FROM kl_product a
		INNER JOIN
		(
			SELECT MAX(kpi_seq) AS kpi_seq, kpi_uri, kpi_prod_seq
			FROM kl_product_img
			WHERE kpi_prod_seq = #{seq}
		)b
		ON a.kp_seq = b.kpi_prod_seq
		)c
		INNER JOIN kl_city d
		ON c.kp_city_seq = d.kc_seq
		)e
		INNER JOIN kl_main_category f
		ON e.kp_mc_seq = f.kmc_seq
		)g
		INNER JOIN kl_sub_category h
		ON g.kp_sc_seq = h.ksc_seq
<!-- 		)i
		INNER JOIN(
			SELECT round(SUM(kr_rate)/COUNT(kr_rate),2) as rate, kr_prod_seq
			FROM kl_review
			WHERE kr_prod_seq = #{seq}
		)j
		ON i.kp_seq = j.kr_prod_seq -->
	</select>
	<select id="selectProductBySeq" resultType="com.klook.vo.ProductVO">
<!-- 	 	SELECT i.*, j.rate AS rate FROM
		(  -->
		SELECT g.*, h.ksc_name AS sub_cate_name FROM
		(
		SELECT e.*, f.kmc_name AS main_cate_name FROM
		(
		SELECT c.*, d.kc_name AS city_name FROM
		(
		SELECT * FROM kl_product a
		INNER JOIN
		(
			SELECT MAX(kpi_seq) AS kpi_seq, kpi_uri, kpi_prod_seq
			FROM kl_product_img
			WHERE kpi_prod_seq = #{seq}
		)b
		ON a.kp_seq = b.kpi_prod_seq
		)c
		INNER JOIN kl_city d
		ON c.kp_city_seq = d.kc_seq
		)e
		INNER JOIN kl_main_category f
		ON e.kp_mc_seq = f.kmc_seq
		)g
		INNER JOIN kl_sub_category h
		ON g.kp_sc_seq = h.ksc_seq
<!-- 		)i
		INNER JOIN(
			SELECT round(SUM(kr_rate)/COUNT(kr_rate),2) as rate, kr_prod_seq
			FROM kl_review
			WHERE kr_prod_seq = #{seq}
		)j
		ON i.kp_seq = j.kr_prod_seq  -->
	</select> 
	<select id="selectSubCategoryProd" resultType="com.klook.vo.ProductVO">
		SELECT a.*, b.ksc_seq AS category
		FROM kl_product a
		INNER JOIN
		kl_sub_category b
		ON a.kp_sc_seq = b.ksc_seq
		WHERE ksc_seq = #{ksc_seq}
	</select>
</mapper>